---
import ProfileLayout from '@layouts/ProfileLayout.astro';
import ProfileCard from '@components/ProfileCard.astro';
import ProfileSEO from '@components/ProfileSEO.astro';
import ProfileAdvancedSEO from '@components/ProfileAdvancedSEO.astro';
import UserNotFound from '@components/UserNotFound.astro';
import { ShareProfile } from '@components/qwik/ShareProfile';
import { StatsGrid } from '@components/qwik/StatsGrid';
import { ContributionGraph } from '@components/qwik/ContributionGraph';
import { RANKS, getRank } from '@lib/kaskus';

// For static site, this would be pre-rendered from data
// In production, fetch from Turso DB
export function getStaticPaths() {
  // Mock users for demo - in production, fetch from DB
  const users = [
    { 
      username: 'budi_fisika',
      name: 'Budi Santoso',
      bio: 'Mahasiswa Fisika ITB | Eksperimenter | OSN Fisika 2022',
      avatar: 'B',
      level: 'Universitas',
      institution: 'Institut Teknologi Bandung',
      location: 'Bandung, Indonesia',
      joined: '2024-03-15',
      posts: 156,
      cendol: 234,
      bata: 12,
      projects: 5,
      contributions: 48,
      interests: ['Optik', 'Mekanika Kuantum', 'DIY Eksperimen'],
      badges: ['üåü Early Member', 'ü•í Cendol Master', 'üî¨ Experimenter', 'üèÜ OSN Medalist'],
      socials: { github: 'budifisika', twitter: 'budi_phy' },
      featured_projects: [
        { title: 'Interferometer Michelson DIY', stars: 24, status: 'completed', tags: ['Optik', 'DIY'] },
        { title: 'Simulasi Gerak Planet', stars: 18, status: 'open', tags: ['Python', 'Astro'] },
      ],
      timeline: [
        { year: '2022', event: 'üèÜ Medali Perak OSN Fisika Tingkat Nasional', type: 'achievement' },
        { year: '2023', event: 'üéì Masuk Fisika ITB', type: 'education' },
        { year: '2024', event: 'üî¨ Memulai proyek Interferometer DIY', type: 'project' },
        { year: '2024', event: 'üìù Publikasi pertama di jurnal mahasiswa', type: 'publication' },
      ]
    },
    {
      username: 'siti_quantum',
      name: 'Siti Nurhaliza',
      bio: 'Physics PhD Student | Quantum Computing Enthusiast',
      avatar: 'S',
      level: 'S2/S3',
      institution: 'Universitas Indonesia',
      location: 'Depok, Indonesia',
      joined: '2023-08-20',
      posts: 312,
      cendol: 567,
      bata: 8,
      projects: 8,
      contributions: 124,
      interests: ['Quantum Computing', 'Fisika Teori', 'Machine Learning'],
      badges: ['üåü Early Member', 'üí° Top Contributor', 'üìö Educator', 'üéØ Mentor'],
      socials: { github: 'sitiquantum', linkedin: 'sitinurhaliza' },
      featured_projects: [
        { title: 'Quantum Circuit Simulator', stars: 45, status: 'open', tags: ['Qiskit', 'Python'] },
        { title: 'Catatan Fisika Kuantum', stars: 32, status: 'completed', tags: ['Edukasi', 'LaTeX'] },
      ],
      timeline: [
        { year: '2020', event: 'üèÜ Juara 1 ONMIPA Fisika', type: 'achievement' },
        { year: '2021', event: 'üéì Lulus S1 Fisika UI Cumlaude', type: 'education' },
        { year: '2022', event: 'üî¨ Research Intern di BRIN', type: 'work' },
        { year: '2023', event: 'üéì Memulai S2 Fisika UI', type: 'education' },
      ]
    },
    {
      username: 'ahmad_osn',
      name: 'Ahmad Rizki',
      bio: 'Siswa SMAN 1 Surabaya | Persiapan OSN Fisika 2026',
      avatar: 'A',
      level: 'SMA',
      institution: 'SMAN 1 Surabaya',
      location: 'Surabaya, Indonesia',
      joined: '2025-01-10',
      posts: 23,
      cendol: 45,
      bata: 2,
      projects: 1,
      contributions: 8,
      interests: ['Olimpiade Fisika', 'Mekanika', 'Elektronika'],
      badges: ['üå± Newcomer', 'üìñ Fast Learner'],
      socials: {},
      featured_projects: [
        { title: 'Catatan Persiapan OSN', stars: 5, status: 'open', tags: ['OSN', 'Catatan'] },
      ],
      timeline: [
        { year: '2025', event: 'üèÜ Lolos OSN Fisika Tingkat Kota', type: 'achievement' },
        { year: '2025', event: 'üìö Bergabung dengan KF13', type: 'community' },
      ]
    }
  ];
  
  return users.map(user => ({
    params: { username: user.username },
    props: { user }
  }));
}

const { user } = Astro.props;

// Handle user not found case
if (!user) {
  return Astro.redirect('/404');
}
const rank = getRank(user.posts);

const stats = [
  { value: user.posts || 0, label: 'Posts', color: 'gray' },
  { value: user.cendol || 0, label: 'Cendol', color: 'green', emoji: 'ü•í' },
  { value: user.projects || 0, label: 'Proyek', color: 'blue' },
  { value: user.contributions || 0, label: 'Kontribusi', color: 'purple' },
  { value: (user.cendol || 0) - (user.bata || 0), label: 'Reputasi', color: 'orange' },
];

const levelColors: Record<string, string> = {
  'SMP': 'bg-blue-100 text-blue-700',
  'SMA': 'bg-green-100 text-green-700',
  'Universitas': 'bg-purple-100 text-purple-700',
  'S2/S3': 'bg-orange-100 text-orange-700',
  'Profesional': 'bg-red-100 text-red-700',
};

const statusColors: Record<string, string> = {
  'open': 'text-green-600',
  'completed': 'text-gray-500',
  'in-progress': 'text-yellow-600',
};

// SVG Icons as constants for better performance
const githubIcon = "M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z";
const twitterIcon = "M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z";
const linkedinIcon = "M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z";
---

<ProfileLayout title={`${user.name} (@${user.username})`} description={user.bio}>
  <ProfileSEO user={user} slot="head" />
  <ProfileAdvancedSEO user={user} slot="head" />
  <style>
    :root {
      --profile-spacing: 1.5rem;
      --card-radius: 1rem;
      --transition-fast: 150ms ease;
      --shadow-light: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      --green-gradient: linear-gradient(135deg, #10b981, #14b8a6);
    }
    
    .timeline-line {
      position: absolute;
      left: 0.5rem;
      top: 0.5rem;
      bottom: 0.5rem;
      width: 0.25rem;
      background: var(--green-gradient);
      border-radius: 9999px;
    }
    
    .timeline-dot {
      position: absolute;
      left: 0.625rem;
      width: 0.75rem;
      height: 0.75rem;
      background: white;
      border: 2px solid #10b981;
      border-radius: 50%;
      box-shadow: var(--shadow-light);
      transition: var(--transition-fast);
    }
    
    .timeline-item:hover .timeline-dot {
      border-color: #059669;
      transform: scale(1.1);
    }
    
    .social-icon {
      width: 1rem;
      height: 1rem;
      fill: currentColor;
    }
    
    /* Performance optimizations */
    .avatar {
      will-change: transform;
      backface-visibility: hidden;
    }
    
    .card-hover {
      will-change: transform, box-shadow;
    }
    
    /* Reduce layout shifts */
    .stats-skeleton {
      min-height: 80px;
    }
  </style>

<ProfileLayout title={`${user.name} (@${user.username})`} description={user.bio}>
  <main class="max-w-5xl mx-auto px-4 py-6" role="main">
    <!-- Profile Header -->
    <header class="bg-white rounded-2xl shadow-sm overflow-hidden mb-6">
      <!-- Banner -->
      <div class="h-32 bg-gradient-to-r from-green-500 via-teal-500 to-blue-500" role="img" aria-label="Profile banner"></div>
      
      <div class="px-6 pb-6">
        <div class="flex flex-col sm:flex-row gap-4 -mt-16">
          <!-- Avatar -->
          <div class="avatar w-32 h-32 bg-gradient-to-br from-green-600 to-teal-600 rounded-2xl border-4 border-white shadow-lg flex items-center justify-center text-white text-5xl font-bold flex-shrink-0 hover:scale-105 transition-transform" role="img" aria-label={`${user.name}'s avatar`}>
            {user.avatar}
          </div>
          
          <div class="flex-1 pt-4 sm:pt-16">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div class="flex-1">
                <h1 class="text-2xl font-bold text-gray-900">{user.name}</h1>
                <p class="text-gray-500 mb-2">@{user.username}</p>
                <div class="flex flex-wrap items-center gap-2">
                  <span class={`px-3 py-1 rounded-full text-sm font-medium ${levelColors[user.level] || 'bg-gray-100 text-gray-700'}`}>
                    {user.level}
                  </span>
                  <span class={`px-3 py-1 rounded-full text-sm font-medium`} style={`background: ${rank.color}20; color: ${rank.color}`}>
                    ‚òÖ {rank.title}
                  </span>
                </div>
              </div>
              
              <!-- Action Buttons -->
              <div class="flex gap-2 sm:flex-shrink-0" role="group" aria-label="Profile actions">
                <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium" aria-label={`Follow ${user.name}`} data-track="follow_button">
                  Follow
                </button>
                <button class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium" aria-label={`Send message to ${user.name}`} data-track="message_button">
                  Pesan
                </button>
              </div>
            </div>
            
            <p class="mt-2 text-gray-700">{user.bio}</p>
            
            <div class="flex flex-wrap gap-4 mt-2 text-sm text-gray-500">
              <span class="flex items-center gap-1">
                <span>üè´</span> {user.institution}
              </span>
              <span class="flex items-center gap-1">
                <span>üìç</span> {user.location}
              </span>
              <span class="flex items-center gap-1">
                <span>üìÖ</span> {new Date(user.joined).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}
              </span>
            </div>

            <nav class="flex gap-2 mt-2" aria-label="Social media links">
              {user.socials.github && (
                <a href={`https://github.com/${user.socials.github}`} target="_blank" rel="noopener noreferrer" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition" aria-label={`${user.name}'s GitHub profile`}>
                  <svg class="social-icon" viewBox="0 0 24 24" aria-hidden="true"><path d={githubIcon}/></svg>
                </a>
              )}
              {user.socials.twitter && (
                <a href={`https://twitter.com/${user.socials.twitter}`} target="_blank" rel="noopener noreferrer" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition" aria-label={`${user.name}'s Twitter profile`}>
                  <svg class="social-icon" viewBox="0 0 24 24" aria-hidden="true"><path d={twitterIcon}/></svg>
                </a>
              )}
              {user.socials.linkedin && (
                <a href={`https://linkedin.com/in/${user.socials.linkedin}`} target="_blank" rel="noopener noreferrer" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition" aria-label={`${user.name}'s LinkedIn profile`}>
                  <svg class="social-icon" viewBox="0 0 24 24" aria-hidden="true"><path d={linkedinIcon}/></svg>
                </a>
              )}
            </nav>
          </div>
        </div>

        <div class="stats-skeleton">
          <StatsGrid stats={stats} client:load />
        </div>
      </div>
    </header>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <section class="lg:col-span-2 space-y-6" aria-label="Main profile content">
        <ProfileCard title="Research Journey" icon="üìÖ">
          {user.timeline && user.timeline.length > 0 ? (
            <div class="relative">
              <div class="timeline-line"></div>
              <div class="space-y-4">
                {user.timeline.map((item: any) => (
                  <div class="timeline-item relative pl-10 hover:bg-gray-50 rounded-lg p-2 -ml-2 transition group">
                    <div class="timeline-dot"></div>
                    <div class="text-sm text-gray-500 font-medium">{item.year}</div>
                    <div class="font-medium text-gray-800">{item.event}</div>
                  </div>
                ))}
              </div>
            </div>
          ) : (
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-2">üìö</div>
              <p>No research timeline yet</p>
            </div>
          )}
        </ProfileCard>

        <ProfileCard title="Featured Projects" icon="üî¨">
          {user.featured_projects && user.featured_projects.length > 0 ? (
            <div class="space-y-4">
              {user.featured_projects.map((project: any) => (
                <div class="group p-5 border border-gray-200 rounded-2xl hover:bg-gray-50 hover:border-gray-300 hover:shadow-md transition-all cursor-pointer">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <div class="flex items-center gap-3 mb-3">
                        <span class={`${statusColors[project.status] || 'text-gray-500'} text-lg`}>‚óè</span>
                        <span class="font-semibold text-gray-900 group-hover:text-green-600 transition">{project.title}</span>
                      </div>
                      <div class="flex gap-2">
                        {project.tags?.map((tag: string) => (
                          <span class="bg-gray-100 hover:bg-green-100 text-gray-700 hover:text-green-700 text-xs px-3 py-1.5 rounded-full transition cursor-pointer font-medium">{tag}</span>
                        ))}
                      </div>
                    </div>
                    <div class="text-yellow-500 font-semibold flex items-center gap-1 bg-yellow-50 px-3 py-1 rounded-full">
                      <span>‚≠ê</span> {project.stars || 0}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-2">üöÄ</div>
              <p>No projects yet</p>
            </div>
          )}
        </ProfileCard>

        <ProfileCard title="Contribution Activity" icon="üìä" lazy>
          <ContributionGraph contributions={user.contributions} client:visible />
        </ProfileCard>
      </section>

      <!-- Sidebar -->
      <aside class="space-y-6" aria-label="Profile sidebar">
        <!-- Badges -->
        <div class="bg-white rounded-2xl shadow-sm p-4 pt-0">
          <h3 class="font-bold py-4 flex items-center gap-2 text-gray-900">
            <span class="text-lg">üèÖ</span> Achievements
          </h3>
          <div class="flex flex-wrap gap-2">
            {user.badges.map((badge: string) => (
              <span class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 text-yellow-800 px-3 py-2 rounded-full text-sm hover:shadow-md hover:scale-105 transition-all cursor-pointer font-medium">
                {badge}
              </span>
            ))}
          </div>
        </div>

        <!-- Interests -->
        <div class="bg-white rounded-2xl shadow-sm p-4 pt-0">
          <h3 class="font-bold py-4 flex items-center gap-2 text-gray-900">
            <span class="text-lg">üéØ</span> Interests
          </h3>
          <div class="flex flex-wrap gap-2">
            {user.interests.map((interest: string) => (
              <span class="bg-gray-100 hover:bg-green-100 hover:text-green-700 px-3 py-2 rounded-full text-sm cursor-pointer transition font-medium">
                {interest}
              </span>
            ))}
          </div>
        </div>

        <!-- Rank Progress -->
        <div class="bg-white rounded-2xl shadow-sm p-4 pt-0">
          <h3 class="font-bold py-4 flex items-center gap-2">
            <span class="text-lg">üèÜ</span> Rank Progress
          </h3>
          <div class="text-center py-4">
            <div class="text-4xl mb-2">‚≠ê</div>
            <div class="font-bold text-lg text-gray-900">{rank.title}</div>
            <div class="text-sm text-gray-500">{user.posts} posts</div>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
            <div class="bg-green-500 h-2 rounded-full transition-all duration-500" style={`width: ${Math.min((user.posts / 500) * 100, 100)}%`}></div>
          </div>
          <p class="text-xs text-gray-500 mt-1 text-center">
            {500 - user.posts > 0 ? `${500 - user.posts} posts lagi ke Kaskus Maniac` : 'Max rank achieved! üéâ'}
          </p>
        </div>

        <ShareProfile username={user.username} client:load />

        <!-- Join Platform CTA -->
        <div class="bg-white rounded-2xl shadow-sm p-4 text-center border-2 border-dashed border-green-200 hover:border-green-300 transition">
          <div class="text-3xl mb-2">üöÄ</div>
          <h3 class="font-bold mb-2 text-gray-900">Bergabung dengan KF13</h3>
          <p class="text-sm text-gray-600 mb-3">Mulai journey riset kamu bersama komunitas fisika Indonesia</p>
          <a href="/mulai" class="block bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition">
            Gabung Sekarang
          </a>
        </div>
      </aside>
    </div>
  </main>
</ProfileLayout>
