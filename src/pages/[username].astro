---
import ProfileLayout from '@layouts/ProfileLayout.astro';
import ProfileCard from '@components/ProfileCard.astro';
import ProfileSEO from '@components/ProfileSEO.astro';
import ProfileAdvancedSEO from '@components/ProfileAdvancedSEO.astro';
import { ShareProfile } from '@components/qwik/ShareProfile';
import { StatsGrid } from '@components/qwik/StatsGrid';
import { ContributionGraph } from '@components/qwik/ContributionGraph';
import { RANKS, getRank } from '@lib/kaskus';
import { MOCK_USERS } from '@lib/mockUsers';
import { SOCIAL_ICONS } from '@lib/socialIcons';
import { LEVEL_COLORS, STATUS_COLORS, createStatsArray } from '@lib/profileUtils';

export function getStaticPaths() {
  return MOCK_USERS.map(user => ({
    params: { username: user.username },
    props: { user }
  }));
}

const { user } = Astro.props;
if (!user) return Astro.redirect('/404');

const rank = getRank(user.posts);
const stats = createStatsArray(user);

// Color gradients for article cards
const ARTICLE_COLORS: Record<string, string> = {
  green: 'from-green-400 to-teal-500',
  purple: 'from-purple-400 to-indigo-500',
  orange: 'from-orange-400 to-red-500',
  blue: 'from-blue-400 to-cyan-500',
  pink: 'from-pink-400 to-rose-500',
  teal: 'from-teal-400 to-emerald-500',
};

const INITIAL_ARTICLES = 6;
const articles = user.articles || [];

// Mock shorts data
const shorts = [
  { id: 1, thumbnail: 'ğŸ”¬', title: 'Eksperimen Cahaya', views: '12K', duration: '0:45' },
  { id: 2, thumbnail: 'âš¡', title: 'Listrik Statis DIY', views: '8.5K', duration: '1:02' },
  { id: 3, thumbnail: 'ğŸŒŠ', title: 'Gelombang Air', views: '5.2K', duration: '0:38' },
  { id: 4, thumbnail: 'ğŸ§²', title: 'Magnet Neodymium', views: '15K', duration: '0:55' },
  { id: 5, thumbnail: 'ğŸ”­', title: 'Teleskop Sederhana', views: '9.1K', duration: '1:15' },
  { id: 6, thumbnail: 'âš—ï¸', title: 'Reaksi Kimia', views: '7.3K', duration: '0:42' },
];
---

<ProfileLayout title={`${user.name} (@${user.username})`} description={user.bio}>
  <ProfileSEO user={user} slot="head" />
  <ProfileAdvancedSEO user={user} slot="head" />

  <main class="max-w-5xl mx-auto px-4 py-6">
    <!-- Profile Header -->
    <header class="bg-white rounded-2xl shadow-sm overflow-hidden mb-6">
      <div class="h-32 bg-gradient-to-r from-green-500 via-teal-500 to-blue-500"></div>
      
      <div class="px-6 pb-6">
        <div class="flex flex-col sm:flex-row gap-4 -mt-16">
          <div class="w-32 h-32 bg-gradient-to-br from-green-600 to-teal-600 rounded-2xl border-4 border-white shadow-lg flex items-center justify-center text-white text-5xl font-bold flex-shrink-0 hover:scale-105 transition-transform">
            {user.avatar}
          </div>
          
          <div class="flex-1 pt-4 sm:pt-16">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div class="flex-1">
                <h1 class="text-2xl font-bold text-gray-900">{user.name}</h1>
                <p class="text-gray-500 mb-2">@{user.username}</p>
                <div class="flex flex-wrap items-center gap-2">
                  <span class={`px-3 py-1 rounded-full text-sm font-medium ${LEVEL_COLORS[user.level] || 'bg-gray-100 text-gray-700'}`}>
                    {user.level}
                  </span>
                  <span class="px-3 py-1 rounded-full text-sm font-medium" style={`background: ${rank.color}20; color: ${rank.color}`}>
                    â˜… {rank.title}
                  </span>
                </div>
              </div>
              
              <div class="flex gap-2">
                <button class="px-5 py-2 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-full hover:from-green-600 hover:to-teal-600 transition-all font-medium text-sm shadow-sm hover:shadow-md">Follow</button>
                <button class="px-5 py-2 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-all font-medium text-sm">Pesan</button>
              </div>
            </div>
            
            <p class="mt-2 text-gray-700">{user.bio}</p>
            
            <div class="flex flex-wrap gap-4 mt-2 text-sm text-gray-500">
              <span class="flex items-center gap-1"><span>ğŸ«</span> {user.institution}</span>
              <span class="flex items-center gap-1"><span>ğŸ“</span> {user.location}</span>
              <span class="flex items-center gap-1"><span>ğŸ“…</span> {new Date(user.joined).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}</span>
            </div>

            <nav class="flex gap-2 mt-2">
              {user.socials?.github && (
                <a href={`https://github.com/${user.socials.github}`} target="_blank" rel="noopener noreferrer" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d={SOCIAL_ICONS.github}/></svg>
                </a>
              )}
              {user.socials?.twitter && (
                <a href={`https://twitter.com/${user.socials.twitter}`} target="_blank" rel="noopener noreferrer" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d={SOCIAL_ICONS.twitter}/></svg>
                </a>
              )}
              {user.socials?.linkedin && (
                <a href={`https://linkedin.com/in/${user.socials.linkedin}`} target="_blank" rel="noopener noreferrer" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d={SOCIAL_ICONS.linkedin}/></svg>
                </a>
              )}
            </nav>
          </div>
        </div>

        <StatsGrid stats={stats} client:load />
      </div>
    </header>

    <!-- Content Tabs -->
    <div class="bg-white rounded-2xl shadow-sm mb-6 overflow-visible">
      <div class="flex gap-1 p-2 bg-gradient-to-r from-green-50 to-teal-50 rounded-t-2xl border-b border-green-100" id="profile-tabs">
        <button class="tab-btn flex-1 py-3 text-sm font-semibold text-green-700 bg-white rounded-xl shadow-sm flex items-center justify-center gap-2 transition-all" data-tab="shorts">
          <span>ğŸ¬</span>
          <span class="hidden sm:inline">Shorts</span>
        </button>
        <button class="tab-btn flex-1 py-3 text-sm font-medium text-gray-600 hover:text-green-700 hover:bg-white/60 rounded-xl flex items-center justify-center gap-2 transition-all" data-tab="articles">
          <span>ğŸ“</span>
          <span class="hidden sm:inline">Artikel</span>
        </button>
        <button class="tab-btn flex-1 py-3 text-sm font-medium text-gray-600 hover:text-green-700 hover:bg-white/60 rounded-xl flex items-center justify-center gap-2 transition-all" data-tab="about">
          <span>ğŸ‘¤</span>
          <span class="hidden sm:inline">Tentang</span>
        </button>
      </div>

      <div>
        <!-- Shorts Carousel -->
        <div id="tab-shorts" class="tab-content py-6 overflow-visible">
          <div class="relative group/carousel px-4">
            <div id="shorts-carousel" class="flex gap-3 overflow-x-auto scroll-smooth scrollbar-hide select-none py-2 -my-2">
              {shorts.map((short) => (
                <div class="flex-shrink-0 w-[calc(33.333%-8px)] sm:w-[calc(25%-8px)] md:w-[calc(20%-8px)]">
                  <div class="aspect-[9/16] bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl overflow-hidden relative cursor-pointer hover:scale-105 transition-transform shadow-sm hover:shadow-xl">
                    <div class="absolute inset-0 flex items-center justify-center text-4xl">{short.thumbnail}</div>
                    <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black/80 to-transparent">
                      <p class="text-white text-xs font-medium truncate">{short.title}</p>
                      <span class="text-white/70 text-[10px]">â–¶ {short.views}</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
            <button id="shorts-prev" class="absolute left-5 top-1/2 -translate-y-1/2 w-9 h-9 bg-white/90 backdrop-blur rounded-full shadow-lg flex items-center justify-center opacity-0 group-hover/carousel:opacity-100 transition-all hover:bg-white hover:scale-110 z-20" aria-label="Previous">
              <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button id="shorts-next" class="absolute right-5 top-1/2 -translate-y-1/2 w-9 h-9 bg-white/90 backdrop-blur rounded-full shadow-lg flex items-center justify-center opacity-0 group-hover/carousel:opacity-100 transition-all hover:bg-white hover:scale-110 z-20" aria-label="Next">
              <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
          </div>
        </div>

        <!-- Articles List -->
        <div id="tab-articles" class="tab-content hidden p-4">
          {articles.length > 0 ? (
            <>
              <div class="columns-2 sm:columns-3 gap-3">
                {articles.slice(0, INITIAL_ARTICLES).map((article: any, index: number) => (
                  <article class="group break-inside-avoid mb-3 bg-gray-50 hover:bg-white rounded-xl hover:shadow-lg transition-all cursor-pointer overflow-hidden relative">
                    {/* Tags */}
                    <div class="absolute top-2 right-2 flex gap-1 z-10">
                      {article.bookmarked && (
                        <span class="w-6 h-6 bg-white/90 backdrop-blur rounded-full flex items-center justify-center text-xs" title="Bookmarked">ğŸ”–</span>
                      )}
                      {article.published && (
                        <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-[10px]" title="Published di Blog KF">âœ“</span>
                      )}
                    </div>
                    {/* Thumbnail */}
                    <div class={`${index % 3 === 1 ? 'h-32' : index % 3 === 2 ? 'h-20' : 'h-24'} bg-gradient-to-br ${ARTICLE_COLORS[article.color] || 'from-gray-400 to-gray-500'} flex items-center justify-center text-3xl`}>
                      {index % 6 === 0 ? 'âš¡' : index % 6 === 1 ? 'ğŸ”¬' : index % 6 === 2 ? 'ğŸ› ï¸' : index % 6 === 3 ? 'ğŸ“' : index % 6 === 4 ? 'ğŸ§ª' : 'ğŸ’¡'}
                    </div>
                    {/* Content */}
                    <div class="p-3">
                      <h3 class="font-semibold text-gray-900 group-hover:text-green-600 transition line-clamp-2 text-sm leading-snug">{article.title}</h3>
                      <p class="text-gray-400 text-xs line-clamp-2 mt-1.5 leading-relaxed">{article.excerpt}</p>
                      <div class="flex items-center gap-2 text-xs text-gray-400 mt-2 pt-2 border-t border-gray-100">
                        <span>{article.readTime}</span>
                        <span class="text-red-400">â™¥ {article.likes}</span>
                        {article.published && (
                          <span class="ml-auto text-[10px] text-green-600 font-medium">Blog KF</span>
                        )}
                      </div>
                    </div>
                  </article>
                ))}
              </div>
              {articles.length > INITIAL_ARTICLES && (
                <button class="w-full mt-4 py-3 text-sm font-medium text-green-600 hover:text-white bg-green-50 hover:bg-gradient-to-r hover:from-green-500 hover:to-teal-500 rounded-xl transition-all">
                  Lihat {articles.length - INITIAL_ARTICLES} Artikel Lainnya â†’
                </button>
              )}
            </>
          ) : (
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-2">ğŸ“</div>
              <p>Belum ada artikel</p>
            </div>
          )}
        </div>

        <!-- About -->
        <div id="tab-about" class="tab-content hidden p-4">
          <div class="grid md:grid-cols-2 gap-4">
            <!-- Left Column -->
            <div class="flex flex-col gap-4">
              <div class="bg-white rounded-2xl shadow-sm p-4 flex-1">
                <h3 class="font-bold text-lg m-0 mb-4 flex items-center gap-2">
                  <span class="text-xl">ğŸ…</span> Pencapaian
                </h3>
                <div class="flex flex-wrap gap-2">
                  {user.badges?.map((badge: string) => (
                    <span class="bg-gray-50 hover:bg-gradient-to-r hover:from-yellow-50 hover:to-orange-50 text-gray-700 hover:text-yellow-700 px-3 py-1.5 rounded-full text-xs hover:shadow-md transition-all cursor-pointer font-medium">{badge}</span>
                  ))}
                </div>
              </div>

              <div class="bg-white rounded-2xl shadow-sm p-4">
                <h3 class="font-bold text-lg m-0 mb-4 flex items-center gap-2">
                  <span class="text-xl">ğŸ¯</span> Minat
                </h3>
                <div class="flex flex-wrap gap-2">
                  {user.interests?.map((interest: string) => (
                    <span class="bg-gray-50 hover:bg-gradient-to-r hover:from-green-50 hover:to-teal-50 text-gray-700 hover:text-green-700 px-3 py-1.5 rounded-full text-xs hover:shadow-md transition-all cursor-pointer font-medium">{interest}</span>
                  ))}
                </div>
              </div>
            </div>

            <!-- Right Column -->
            <div class="bg-white rounded-2xl shadow-sm p-4">
              <h3 class="font-bold text-lg m-0 mb-4 flex items-center gap-2">
                <span class="text-xl">ğŸ“…</span> Perjalanan Riset
              </h3>
              {user.timeline && user.timeline.length > 0 ? (
                <div class="relative pl-6">
                  <div class="absolute left-[5px] top-1.5 bottom-1.5 w-0.5 bg-gradient-to-b from-green-400 to-teal-500 rounded-full"></div>
                  <div class="space-y-4">
                    {user.timeline.map((item: any) => (
                      <div class="relative group">
                        <div class="absolute -left-6 top-3 w-3 h-3 bg-green-500 rounded-full group-hover:scale-125 transition-transform"></div>
                        <div class="bg-gray-50 hover:bg-white rounded-lg p-3 hover:shadow-md transition-all">
                          <div class="text-xs text-green-600 font-semibold">{item.year}</div>
                          <div class="text-sm text-gray-800">{item.event}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <div class="text-center py-6 text-gray-400">
                  <div class="text-2xl mb-1">ğŸš€</div>
                  <p class="text-xs">Belum ada journey</p>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Existing Grid Layout -->
    <div class="grid lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 space-y-6">
        <ProfileCard title="Featured Projects" icon="ğŸ”¬">
          {user.featured_projects && user.featured_projects.length > 0 ? (
            <div class="space-y-4">
              {user.featured_projects.map((project: any) => (
                <div class="group p-4 bg-gray-50 hover:bg-white rounded-2xl hover:shadow-lg transition-all cursor-pointer">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <div class="flex items-center gap-3 mb-3">
                        <span class={`${STATUS_COLORS[project.status] || 'text-gray-500'} text-lg`}>â—</span>
                        <span class="font-semibold text-gray-900 group-hover:text-green-600 transition">{project.title}</span>
                      </div>
                      <div class="flex gap-2">
                        {project.tags?.map((tag: string) => (
                          <span class="bg-gray-100 hover:bg-green-100 text-gray-700 hover:text-green-700 text-xs px-3 py-1.5 rounded-full transition cursor-pointer font-medium">{tag}</span>
                        ))}
                      </div>
                    </div>
                    <div class="text-yellow-500 font-semibold flex items-center gap-1 bg-yellow-50 px-3 py-1 rounded-full">
                      <span>â­</span> {project.stars || 0}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-2">ğŸš€</div>
              <p>No projects yet</p>
            </div>
          )}
        </ProfileCard>

        <ProfileCard title="Contribution Activity" icon="ğŸ“Š" lazy>
          <ContributionGraph contributions={user.contributions} client:load />
        </ProfileCard>
      </section>

      <aside class="space-y-6">
        <ProfileCard title="Rank Progress" icon="ğŸ†">
          <div class="text-center py-4">
            <div class="text-4xl mb-2">â­</div>
            <div class="font-bold text-lg text-gray-900">{rank.title}</div>
            <div class="text-sm text-gray-500">{user.posts} posts</div>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
            <div class="bg-green-500 h-2 rounded-full" style={`width: ${Math.min((user.posts / 500) * 100, 100)}%`}></div>
          </div>
          <p class="text-xs text-gray-500 mt-1 text-center">
            {500 - user.posts > 0 ? `${500 - user.posts} posts lagi ke Kaskus Maniac` : 'Max rank achieved! ğŸ‰'}
          </p>
        </ProfileCard>

        <ProfileCard title="Share Profile" icon="ğŸ”—" variant="gradient">
          <ShareProfile username={user.username} client:load />
        </ProfileCard>

        <div class="bg-gradient-to-br from-green-50 to-teal-50 rounded-2xl shadow-sm p-4 text-center hover:shadow-md transition">
          <div class="text-3xl mb-2">ğŸš€</div>
          <h3 class="font-bold mb-2 text-gray-900">Bergabung dengan KF13</h3>
          <p class="text-sm text-gray-600 mb-3">Mulai journey riset kamu bersama komunitas fisika Indonesia</p>
          <a href="/mulai" class="block bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition">
            Gabung Sekarang
          </a>
        </div>
      </aside>
    </div>
  </main>
</ProfileLayout>

<script>
  // Tab switching
  const tabs = document.querySelectorAll('.tab-btn');
  const contents = document.querySelectorAll('.tab-content');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.getAttribute('data-tab');
      
      tabs.forEach(t => {
        t.classList.remove('text-green-700', 'bg-white', 'shadow-sm', 'font-semibold');
        t.classList.add('text-gray-500', 'font-medium');
      });
      tab.classList.add('text-green-700', 'bg-white', 'shadow-sm', 'font-semibold');
      tab.classList.remove('text-gray-500', 'font-medium');
      
      contents.forEach(c => c.classList.add('hidden'));
      document.getElementById(`tab-${target}`)?.classList.remove('hidden');
    });
  });

  // Shorts carousel navigation
  const carousel = document.getElementById('shorts-carousel');
  const prevBtn = document.getElementById('shorts-prev');
  const nextBtn = document.getElementById('shorts-next');
  
  if (carousel && prevBtn && nextBtn) {
    const scrollAmount = carousel.offsetWidth * 0.8;
    
    nextBtn.addEventListener('click', () => {
      carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    });
    
    prevBtn.addEventListener('click', () => {
      carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    });

    // Drag scroll
    let isDown = false;
    let startX: number;
    let scrollLeft: number;

    carousel.addEventListener('mousedown', (e) => {
      isDown = true;
      carousel.style.cursor = 'grabbing';
      startX = e.pageX - carousel.offsetLeft;
      scrollLeft = carousel.scrollLeft;
    });

    carousel.addEventListener('mouseleave', () => {
      isDown = false;
      carousel.style.cursor = 'grab';
    });

    carousel.addEventListener('mouseup', () => {
      isDown = false;
      carousel.style.cursor = 'grab';
    });

    carousel.addEventListener('mousemove', (e) => {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - carousel.offsetLeft;
      carousel.scrollLeft = scrollLeft - (x - startX);
    });

    carousel.style.cursor = 'grab';
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  /* Clip hanya horizontal untuk carousel, allow vertical overflow */
  #shorts-carousel {
    overflow-y: visible;
    overflow-x: auto;
  }
</style>
