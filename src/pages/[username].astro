---
import ProfileLayout from '@layouts/ProfileLayout.astro';
import ProfileCard from '@components/ProfileCard.astro';
import ProfileSEO from '@components/ProfileSEO.astro';
import ProfileAdvancedSEO from '@components/ProfileAdvancedSEO.astro';
import { ShareProfile } from '@components/qwik/ShareProfile';
import { StatsGrid } from '@components/qwik/StatsGrid';
import { ContributionGraph } from '@components/qwik/ContributionGraph';
import { RANKS, getRank } from '@lib/kaskus';
import { MOCK_USERS } from '@lib/mockUsers';
import { SOCIAL_ICONS } from '@lib/socialIcons';
import { LEVEL_COLORS, STATUS_COLORS, createStatsArray } from '@lib/profileUtils';

export function getStaticPaths() {
  return MOCK_USERS.map(user => ({
    params: { username: user.username },
    props: { user }
  }));
}

const { user } = Astro.props;
if (!user) return Astro.redirect('/404');

const rank = getRank(user.posts);
const stats = createStatsArray(user);
---

<ProfileLayout title={`${user.name} (@${user.username})`} description={user.bio}>
  <ProfileSEO user={user} slot="head" />
  <ProfileAdvancedSEO user={user} slot="head" />

  <main class="max-w-5xl mx-auto px-4 py-6">
    <!-- Profile Header -->
    <header class="bg-white rounded-2xl shadow-sm overflow-hidden mb-6">
      <div class="h-32 bg-gradient-to-r from-green-500 via-teal-500 to-blue-500"></div>
      
      <div class="px-6 pb-6">
        <div class="flex flex-col sm:flex-row gap-4 -mt-16">
          <div class="w-32 h-32 bg-gradient-to-br from-green-600 to-teal-600 rounded-2xl border-4 border-white shadow-lg flex items-center justify-center text-white text-5xl font-bold flex-shrink-0 hover:scale-105 transition-transform">
            {user.avatar}
          </div>
          
          <div class="flex-1 pt-4 sm:pt-16">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div class="flex-1">
                <h1 class="text-2xl font-bold text-gray-900">{user.name}</h1>
                <p class="text-gray-500 mb-2">@{user.username}</p>
                <div class="flex flex-wrap items-center gap-2">
                  <span class={`px-3 py-1 rounded-full text-sm font-medium ${LEVEL_COLORS[user.level] || 'bg-gray-100 text-gray-700'}`}>
                    {user.level}
                  </span>
                  <span class="px-3 py-1 rounded-full text-sm font-medium" style={`background: ${rank.color}20; color: ${rank.color}`}>
                    â˜… {rank.title}
                  </span>
                </div>
              </div>
              
              <div class="flex gap-2">
                <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">Follow</button>
                <button class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">Pesan</button>
              </div>
            </div>
            
            <p class="mt-2 text-gray-700">{user.bio}</p>
            
            <div class="flex flex-wrap gap-4 mt-2 text-sm text-gray-500">
              <span class="flex items-center gap-1"><span>ğŸ«</span> {user.institution}</span>
              <span class="flex items-center gap-1"><span>ğŸ“</span> {user.location}</span>
              <span class="flex items-center gap-1"><span>ğŸ“…</span> {new Date(user.joined).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}</span>
            </div>

            <nav class="flex gap-2 mt-2">
              {user.socials?.github && (
                <a href={`https://github.com/${user.socials.github}`} target="_blank" rel="noopener noreferrer" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d={SOCIAL_ICONS.github}/></svg>
                </a>
              )}
              {user.socials?.twitter && (
                <a href={`https://twitter.com/${user.socials.twitter}`} target="_blank" rel="noopener noreferrer" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d={SOCIAL_ICONS.twitter}/></svg>
                </a>
              )}
              {user.socials?.linkedin && (
                <a href={`https://linkedin.com/in/${user.socials.linkedin}`} target="_blank" rel="noopener noreferrer" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d={SOCIAL_ICONS.linkedin}/></svg>
                </a>
              )}
            </nav>
          </div>
        </div>

        <StatsGrid stats={stats} client:only="qwik" />
      </div>
    </header>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <section class="lg:col-span-2 space-y-6">
        <ProfileCard title="Research Journey" icon="ğŸ“…">
          {user.timeline && user.timeline.length > 0 ? (
            <div class="relative">
              <div class="absolute left-2 top-2 bottom-2 w-1 bg-gradient-to-b from-green-400 via-green-500 to-green-600 rounded-full"></div>
              <div class="space-y-4">
                {user.timeline.map((item: any) => (
                  <div class="relative pl-10 hover:bg-gray-50 rounded-lg p-2 -ml-2 transition group">
                    <div class="absolute left-2.5 w-3 h-3 bg-white border-2 border-green-500 rounded-full shadow-sm"></div>
                    <div class="text-sm text-gray-500 font-medium">{item.year}</div>
                    <div class="font-medium text-gray-800">{item.event}</div>
                  </div>
                ))}
              </div>
            </div>
          ) : (
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-2">ğŸ“š</div>
              <p>No research timeline yet</p>
            </div>
          )}
        </ProfileCard>

        <ProfileCard title="Featured Projects" icon="ğŸ”¬">
          {user.featured_projects && user.featured_projects.length > 0 ? (
            <div class="space-y-4">
              {user.featured_projects.map((project: any) => (
                <div class="group p-5 border border-gray-200 rounded-2xl hover:bg-gray-50 hover:border-gray-300 hover:shadow-md transition-all cursor-pointer">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <div class="flex items-center gap-3 mb-3">
                        <span class={`${STATUS_COLORS[project.status] || 'text-gray-500'} text-lg`}>â—</span>
                        <span class="font-semibold text-gray-900 group-hover:text-green-600 transition">{project.title}</span>
                      </div>
                      <div class="flex gap-2">
                        {project.tags?.map((tag: string) => (
                          <span class="bg-gray-100 hover:bg-green-100 text-gray-700 hover:text-green-700 text-xs px-3 py-1.5 rounded-full transition cursor-pointer font-medium">{tag}</span>
                        ))}
                      </div>
                    </div>
                    <div class="text-yellow-500 font-semibold flex items-center gap-1 bg-yellow-50 px-3 py-1 rounded-full">
                      <span>â­</span> {project.stars || 0}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-2">ğŸš€</div>
              <p>No projects yet</p>
            </div>
          )}
        </ProfileCard>

        <ProfileCard title="Contribution Activity" icon="ğŸ“Š" lazy>
          <ContributionGraph contributions={user.contributions} client:only="qwik" />
        </ProfileCard>
      </section>

      <!-- Sidebar -->
      <aside class="space-y-6">
        <ProfileCard title="Achievements" icon="ğŸ…">
          <div class="flex flex-wrap gap-2">
            {user.badges?.map((badge: string) => (
              <span class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 text-yellow-800 px-3 py-2 rounded-full text-sm hover:shadow-md hover:scale-105 transition-all cursor-pointer font-medium">
                {badge}
              </span>
            ))}
          </div>
        </ProfileCard>

        <ProfileCard title="Interests" icon="ğŸ¯">
          <div class="flex flex-wrap gap-2">
            {user.interests?.map((interest: string) => (
              <span class="bg-gray-100 hover:bg-green-100 hover:text-green-700 px-3 py-2 rounded-full text-sm cursor-pointer transition font-medium">
                {interest}
              </span>
            ))}
          </div>
        </ProfileCard>

        <ProfileCard title="Rank Progress" icon="ğŸ†">
          <div class="text-center py-4">
            <div class="text-4xl mb-2">â­</div>
            <div class="font-bold text-lg text-gray-900">{rank.title}</div>
            <div class="text-sm text-gray-500">{user.posts} posts</div>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
            <div class="bg-green-500 h-2 rounded-full" style={`width: ${Math.min((user.posts / 500) * 100, 100)}%`}></div>
          </div>
          <p class="text-xs text-gray-500 mt-1 text-center">
            {500 - user.posts > 0 ? `${500 - user.posts} posts lagi ke Kaskus Maniac` : 'Max rank achieved! ğŸ‰'}
          </p>
        </ProfileCard>

        <ShareProfile username={user.username} client:only="qwik" />

        <div class="bg-white rounded-2xl shadow-sm p-4 text-center border-2 border-dashed border-green-200 hover:border-green-300 transition">
          <div class="text-3xl mb-2">ğŸš€</div>
          <h3 class="font-bold mb-2 text-gray-900">Bergabung dengan KF13</h3>
          <p class="text-sm text-gray-600 mb-3">Mulai journey riset kamu bersama komunitas fisika Indonesia</p>
          <a href="/mulai" class="block bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition">
            Gabung Sekarang
          </a>
        </div>
      </aside>
    </div>
  </main>
</ProfileLayout>
