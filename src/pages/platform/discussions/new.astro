---
import PlatformLayout from '@layouts/PlatformLayout.astro';
import { EMOTICONS } from '@lib/kaskus';

const threadTypes = [
  { id: 'ask', label: 'ASK', desc: 'Tanya jawab dan diskusi', color: 'bg-blue-100 text-blue-700' },
  { id: 'share', label: 'SHARE', desc: 'Berbagi pengalaman/hasil', color: 'bg-green-100 text-green-700' },
  { id: 'tutorial', label: 'TUTORIAL', desc: 'Panduan step-by-step', color: 'bg-purple-100 text-purple-700' },
  { id: 'debat', label: 'DEBAT', desc: 'Diskusi argumentatif', color: 'bg-orange-100 text-orange-700' },
  { id: 'proyek', label: 'PROYEK', desc: 'Kolaborasi project', color: 'bg-pink-100 text-pink-700' },
];

const categories = [
  { id: 'modern', label: 'Fisika Modern', icon: '‚öõÔ∏è' },
  { id: 'mechanics', label: 'Mekanika', icon: 'üîß' },
  { id: 'olympiad', label: 'Olimpiade', icon: 'üèÜ' },
  { id: 'career', label: 'Karir & Kuliah', icon: 'üíº' },
  { id: 'lounge', label: 'Lounge', icon: 'üéÆ' },
];
---

<script>
  import { redirectIfGuest } from '../../../lib/router';
  redirectIfGuest();
</script>

<PlatformLayout title="Buat Thread Baru" activeNav="/platform/discussions">
  <!-- Breadcrumb -->
  <div class="text-sm text-gray-400 mb-4">
    <a href="/platform/discussions" class="hover:text-green-600 transition">Forum</a>
    <span class="mx-2">‚Ä∫</span>
    <span>Buat Thread Baru</span>
  </div>

  <!-- Create Thread Form -->
  <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white p-6">
      <h1 class="text-2xl font-bold">Buat Thread Baru</h1>
      <p class="text-sm opacity-90 mt-1">Bagikan pengetahuan, tanya jawab, atau mulai diskusi</p>
    </div>

    <!-- Form -->
    <form class="p-6 space-y-6" id="create-thread-form">
      <!-- Thread Type -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-3">Tipe Thread</label>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
          {threadTypes.map(type => (
            <label class="cursor-pointer">
              <input type="radio" name="type" value={type.id} class="sr-only peer" required />
              <div class={`p-3 rounded-lg border-2 border-gray-200 peer-checked:border-green-500 peer-checked:${type.color} transition text-center`}>
                <div class="font-medium text-sm">{type.label}</div>
                <div class="text-xs text-gray-500 mt-1">{type.desc}</div>
              </div>
            </label>
          ))}
        </div>
      </div>

      <!-- Category -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-3">Kategori</label>
        <select name="category" class="w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
          <option value="">Pilih kategori...</option>
          {categories.map(cat => (
            <option value={cat.id}>{cat.icon} {cat.label}</option>
          ))}
        </select>
      </div>

      <!-- Title -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Judul Thread</label>
        <input 
          type="text" 
          name="title" 
          placeholder="Tulis judul yang menarik dan deskriptif..."
          class="w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
          maxlength="100"
          required
        />
        <div class="text-xs text-gray-400 mt-1">Maksimal 100 karakter</div>
      </div>

      <!-- Tags -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
        <input 
          type="text" 
          name="tags" 
          placeholder="fisika, eksperimen, diy (pisahkan dengan koma)"
          class="w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        />
        <div class="text-xs text-gray-400 mt-1">Maksimal 5 tags, pisahkan dengan koma</div>
      </div>

      <!-- Content -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Konten</label>
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <!-- Toolbar -->
          <div class="bg-gray-50 px-3 py-2 border-b border-gray-200 flex items-center gap-2">
            <button type="button" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded" title="Bold">
              <strong>B</strong>
            </button>
            <button type="button" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded" title="Italic">
              <em>I</em>
            </button>
            <button type="button" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded" title="Code">
              üíª
            </button>
            <button type="button" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded" title="Math">
              ‚àë
            </button>
            <button type="button" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded" title="Emoticon">
              üòÄ
            </button>
          </div>
          
          <!-- Textarea -->
          <textarea 
            name="content" 
            placeholder="Tulis konten thread... Mendukung Markdown, LaTeX, dan emoticon Kaskus!"
            class="w-full p-4 resize-none focus:outline-none"
            rows="12"
            required
          ></textarea>
        </div>
        
        <!-- Help Text -->
        <div class="text-xs text-gray-400 mt-2 space-y-1">
          <div><strong>Markdown:</strong> **bold**, *italic*, `code`, ## heading</div>
          <div><strong>LaTeX:</strong> $$E = mc^2$$, $\alpha + \beta$</div>
          <div><strong>Emoticon:</strong> :cendol :bata :mantap :cool</div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex items-center justify-between pt-4 border-t border-gray-100">
        <a href="/platform/discussions" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition">
          Batal
        </a>
        <div class="flex gap-3">
          <button type="button" class="px-4 py-2 border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 transition">
            Simpan Draft
          </button>
          <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition">
            Posting Thread
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Preview Modal (Hidden) -->
  <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
          <h3 class="font-bold">Preview Thread</h3>
          <button id="close-preview" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <div id="preview-content" class="p-6 overflow-y-auto max-h-[70vh]">
          <!-- Preview content will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Form handling
    document.getElementById('create-thread-form')?.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Get form data
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      
      // Show success message
      const success = document.createElement('div');
      success.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      success.textContent = 'Thread berhasil dibuat! Redirecting...';
      document.body.appendChild(success);
      
      // Simulate redirect to new thread
      setTimeout(() => {
        window.location.href = '/platform/discussions/berhasil-bikin-interferometer-michelson-dari-cermi-f7g8h9i0j1k2';
      }, 2000);
    });

    // Toolbar functionality
    document.querySelectorAll('[title="Bold"]').forEach(btn => {
      btn.addEventListener('click', () => insertText('**', '**'));
    });
    
    document.querySelectorAll('[title="Italic"]').forEach(btn => {
      btn.addEventListener('click', () => insertText('*', '*'));
    });
    
    document.querySelectorAll('[title="Code"]').forEach(btn => {
      btn.addEventListener('click', () => insertText('`', '`'));
    });
    
    document.querySelectorAll('[title="Math"]').forEach(btn => {
      btn.addEventListener('click', () => insertText('$$', '$$'));
    });

    function insertText(before, after) {
      const textarea = document.querySelector('textarea[name="content"]');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      const selectedText = text.substring(start, end);
      
      textarea.value = text.substring(0, start) + before + selectedText + after + text.substring(end);
      textarea.focus();
      textarea.setSelectionRange(start + before.length, start + before.length + selectedText.length);
    }
  </script>
</PlatformLayout>
