---
import { EMOTICONS } from '@lib/kaskus';

interface Props {
  limit?: number;
}

const { limit = 8 } = Astro.props;
const emoticons = Object.entries(EMOTICONS).slice(0, limit);
---

<div id="emoticon-legend" class="grid grid-cols-2 gap-2 text-sm">
  {emoticons.map(([code, emoji]) => (
    <button 
      type="button"
      class="emoticon-btn flex items-center gap-2 p-1 rounded hover:bg-gray-100 transition text-left"
      data-code={code}
    >
      <span>{emoji}</span>
      <code class="text-xs text-gray-500">{code}</code>
    </button>
  ))}
</div>

<script>
  document.querySelectorAll('.emoticon-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const code = btn.getAttribute('data-code');
      if (!code) return;
      
      // Find active textarea or last focused one
      const textarea = document.querySelector('textarea:focus') as HTMLTextAreaElement 
        || document.querySelector('#reply-input') as HTMLTextAreaElement;
      
      if (textarea) {
        // Insert at cursor position
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        textarea.value = text.substring(0, start) + code + ' ' + text.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + code.length + 1;
        textarea.focus();
      } else {
        // Fallback: copy to clipboard with visual feedback
        try {
          await navigator.clipboard.writeText(code);
          
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="w-full text-center text-green-600 font-medium">âœ“ Copied!</span>';
          btn.classList.add('bg-green-50', 'border-green-200');
          btn.style.transform = 'scale(0.95)';
          
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('bg-green-50', 'border-green-200');
            btn.style.transform = '';
          }, 1200);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      }
    });
  });
</script>
