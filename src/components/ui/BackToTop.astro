---
interface Props {
  threshold?: number;
  showReadingTime?: boolean;
  articleSelector?: string;
}

const { 
  threshold = 300, 
  showReadingTime = false,
  articleSelector = '.article-content'
} = Astro.props;
---

<button
  id="back-to-top"
  class="fixed bottom-6 left-6 z-50 w-12 h-12 btn-secondary font-black text-xl shadow-brutal hover:shadow-brutal-hover transition-all transform hover:scale-110 opacity-0 translate-y-10 pointer-events-none"
  style="position: fixed !important;"
  aria-label="Back to top"
>
  <!-- Progress Border SVG -->
  <svg class="absolute inset-0 w-full h-full" viewBox="0 0 48 48" style="position: absolute;">
    <!-- Background border -->
    <rect
      x="2"
      y="2"
      width="44"
      height="44"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      opacity="0.2"
    />
    <!-- Progress border -->
    <rect
      id="progress-rect"
      x="2"
      y="2"
      width="44"
      height="44"
      fill="none"
      stroke="#1d4ed8"
      stroke-width="2"
      stroke-linecap="round"
      stroke-dasharray="176"
      stroke-dashoffset="176"
      class="transition-all duration-100 ease-out"
    />
  </svg>
  
  <!-- Button Content -->
  <span style="position: relative; z-index: 10;" class="text-dark dark:text-light">â†‘</span>
</button>

<!-- Reading Time Indicator (for articles) - hidden, info shown in header -->
{showReadingTime && (
  <div
    id="reading-time-indicator"
    class="sr-only"
    aria-hidden="true"
  >
    <span id="reading-time-text">0 menit baca</span>
  </div>
)}

<script define:vars={{ threshold, showReadingTime, articleSelector }}>
document.addEventListener('DOMContentLoaded', () => {
  const backToTopBtn = document.getElementById('back-to-top');
  const progressRect = document.getElementById('progress-rect');
  const readingTimeIndicator = document.getElementById('reading-time-indicator');
  const readingTimeText = document.getElementById('reading-time-text');
  
  if (!backToTopBtn || !progressRect) return;
  
  // Get article element for enhanced progress calculation
  const article = document.querySelector(articleSelector);
  
  const updateProgress = () => {
    const scrollTop = window.scrollY;
    let scrollPercent = 0;
    
    if (article && showReadingTime) {
      // Enhanced progress calculation for articles
      const articleTop = article.offsetTop;
      const articleHeight = article.offsetHeight;
      const windowHeight = window.innerHeight;
      
      scrollPercent = Math.min(
        Math.max((scrollTop - articleTop + windowHeight) / articleHeight, 0),
        1
      );
    } else {
      // Standard progress calculation
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      scrollPercent = Math.min(Math.max(scrollTop / docHeight, 0), 1);
    }
    
    // Update progress rectangle
    const perimeter = 176; // 4 * 44 (rectangle perimeter)
    const offset = perimeter - (scrollPercent * perimeter);
    progressRect.style.strokeDashoffset = offset.toString();
    
    // Show/hide button based on scroll position
    const shouldShow = scrollTop > threshold;
    
    if (shouldShow) {
      backToTopBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
      backToTopBtn.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
      
      // Show reading time indicator for articles
      if (readingTimeIndicator && showReadingTime) {
        readingTimeIndicator.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
        readingTimeIndicator.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
      }
    } else {
      backToTopBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
      backToTopBtn.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
      
      // Hide reading time indicator
      if (readingTimeIndicator) {
        readingTimeIndicator.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
        readingTimeIndicator.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
      }
    }
  };
  
  window.addEventListener('scroll', updateProgress);
  backToTopBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  
  // Set reading time text if provided
  if (readingTimeText && showReadingTime) {
    // Try to get reading time from meta or calculate
    const readingTimeMeta = document.querySelector('meta[name="reading-time"]');
    if (readingTimeMeta) {
      readingTimeText.textContent = readingTimeMeta.content;
    } else if (article) {
      // Calculate reading time (200 words per minute)
      const wordCount = article.textContent?.split(/\s+/).length || 0;
      const readingTime = Math.ceil(wordCount / 200);
      readingTimeText.textContent = `${readingTime} menit baca`;
    }
  }
  
  // Initial call
  updateProgress();
});
</script>
