---
interface Props {
  id: string;
  title?: string;
}

const { id, title } = Astro.props;
---

<div id={id} class="modal-overlay hidden">
  <div class="modal-brutal">
    {title && <div class="modal-header">{title}</div>}
    <div class="modal-body">
      <slot />
    </div>
    <button class="modal-close" data-modal-close aria-label="Close modal">Ã—</button>
  </div>
</div>

<style>
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  
  .modal-overlay.hidden {
    display: none;
  }
  
  .modal-brutal {
    background: white;
    border: 4px solid #1a1a1a;
    box-shadow: 8px 8px 0 #1a1a1a;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    position: relative;
    transform: rotate(-1deg);
  }
  
  .modal-header {
    font-size: 1.25rem;
    font-weight: 900;
    text-transform: uppercase;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 3px solid #1a1a1a;
  }
  
  .modal-body {
    font-size: 1rem;
    line-height: 1.5;
  }
  
  .modal-close {
    position: absolute;
    top: -12px;
    right: -12px;
    width: 36px;
    height: 36px;
    background: #fbbf24;
    border: 3px solid #1a1a1a;
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.15s;
  }
  
  .modal-close:hover {
    transform: scale(1.1) rotate(90deg);
  }
</style>

<script define:vars={{ id }}>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById(id);
    if (!modal) return;
    
    let previousFocus = null;
    
    // Focus management
    const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    
    function trapFocus(e) {
      const focusable = modal.querySelectorAll(focusableElements);
      const firstFocusable = focusable[0];
      const lastFocusable = focusable[focusable.length - 1];
      
      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === firstFocusable) {
            lastFocusable.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === lastFocusable) {
            firstFocusable.focus();
            e.preventDefault();
          }
        }
      }
    }
    
    function openModal() {
      previousFocus = document.activeElement;
      modal.classList.remove('hidden');
      const closeButton = modal.querySelector('[data-modal-close]');
      closeButton?.focus();
      document.addEventListener('keydown', trapFocus);
    }
    
    function closeModal() {
      modal.classList.add('hidden');
      document.removeEventListener('keydown', trapFocus);
      previousFocus?.focus();
    }
    
    // Close on button click
    modal.querySelector('[data-modal-close]')?.addEventListener('click', closeModal);
    
    // Close on overlay click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
    
    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });
    
    // Expose openModal for external use
    window[`openModal_${id}`] = openModal;
  });
</script>
